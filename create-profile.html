<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description" content="La página web en la que los usuarios comparten sus anécdotas y puntos de vista.">
  <meta name="theme-color" content="#0d6efd">
  <link rel="canonical" href="https://talkers.social">
  
  <title>Talkers</title>

  <!-- MDB icon -->
  <link rel="icon" href="img/Logo.svg" type="image/x-icon" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" />
  <!-- MDB -->
  <link rel="stylesheet" href="css/mdb.min.css" />

  <style>
    .mask-custom {
      backdrop-filter: blur(2px);

    }

    @media screen and (max-width: 580px) {
      #navbar {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
      }

      #navbar-left {
        display: flex !important;
        align-items: center !important;
        width: 100% !important;
        justify-content: center;
        margin-bottom: 10px;
      }
    }
  </style>

</head>
<body>

    <div class="container position-absolute top-50 translate-middle start-50">
      <div class="row py-5 shadow-2-soft rounded-2" id="row1">
        <div class="col-md text-center">
            <input type="file" style="display: none;" id="profileInput" accept="image/*">
            <button 
            onclick="document.getElementById('profileInput').click()"
            id="profileButton"
            class="btn w-50 rounded-circle bg-black mx-auto bg-opacity-50 bg-image" style="background-image: url('./img/welcome/woman-taking-selfie.svg');aspect-ratio: 1/1; appearance: none;"></button>
        </div>
        <div class="col-md text-center d-flex flex-column justify-content-center align-items-center">
            <p class="text-primary fs-2 fw-bold">Foto de perfil</p>
            <p class="w-75 text-muted my-4">Añade una foto de perfil. <br> Intenta que no sea muy pesada.</p>
            <div class="progress w-75 rounded-3 opacity-1" id="loader" style="height: 20px;">
              <div class="progress-bar bg-success bg-opacity-75" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">Elija una imagen</div>
            </div>
            <button class="btn bg-primary text-white bg-opacity-75 disabled mt-5" id="nextStep1">Seguir <i class="fas fa-arrow-right"></i></button>
        </div>
      </div>  
      <div class="row py-5 shadow-2-soft rounded-2 d-none" id="row2">
        <div class="col-md">
            <div class="text-center">
                <img src="./img/welcome/content-creator.svg" style="max-width: 300px;" alt="">
            </div>
        </div>
        <div class="col-md">
            <p class="text-primary fs-2 fw-bold text-center">Nombre de usuario</p>
            <p class="w-75 text-muted my-4 text-center mx-auto">Elige tu nombre de usuario</p>
            <div class="form-outline mx-auto" style="max-width: 300px;">
                <p class="trailing" id="userNameTag">#0000</p>
                <input type="text" id="usernameInput" class="form-control form-icon-trailing"/>
                <label class="form-label" for="usernameInput">Apodo</label>
            </div>
            <div class="text-center">
                <button class="btn bg-primary text-white bg-opacity-75 mt-5" id="previousRow2"><i class="fas fa-arrow-left"></i> Volver</button>
                <button class="btn bg-primary text-white bg-opacity-75 disabled mt-5" id="nextRow2">Seguir <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
      </div>  
      <div class="row py-5 shadow-2-soft rounded-2 d-none" id="row3">
        <div class="col-md">
            <div class="text-center">
                <img src="./img/welcome/office-workplace.svg"  style="max-width: 300px;" alt="">
            </div>
        </div>
        <div class="col-md">
            <p class="text-primary fs-2 fw-bold text-center">Háblanos sobre tí</p>
            <p class="w-75 text-muted my-4 text-center mx-auto">Escribe una descripción sobre tí</p>
            <div class="form-outline">
                <textarea class="form-control" id="descInput" rows="4" data-mdb-showcounter="true" maxlength="155" ></textarea>
                <label class="form-label" for="descInput">Descripción de usuario</label>
                <div class="form-helper"></div>
              </div>
            <div class="text-center">
                <button class="btn bg-primary text-white bg-opacity-75 mt-5" id="previousRow3"><i class="fas fa-arrow-left"></i> Volver</button>
                <button class="btn bg-primary text-white bg-opacity-75 disabled mt-5" id="nextRow3">Seguir <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
      </div>
      <div class="row py-5 shadow-2-soft rounded-2 d-none" id="row4">
        <div class="col-md text-center">
            <img src="./img/welcome/signing-terms-of-services.svg">
        </div>
        <div class="col-md text-center d-flex flex-column justify-content-center align-items-center">
            <p class="text-primary fs-2 fw-bold">Para terminar</p>
            <p class="w-75 text-muted my-4">Acepta los <a href="#">términos y condiciones.</a></p>
            <div class="form-check">
              <input class="form-check-input" type="checkbox"  id="termsInput" />
              <label class="form-check-label" for="termsInput">He leído y acepto los términos y condiciones.</label>
            </div>
            <div class="text-center">
              <button class="btn bg-primary text-white bg-opacity-75 mt-5" id="previousRow4"><i class="fas fa-arrow-left"></i> Volver</button>
              <button class="btn bg-primary text-white bg-opacity-75 disabled mt-5" id="nextRow4">Seguir <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>
      </div> 

    </div>


  <script type="text/javascript" src="js/mdb.min.js"></script>
  <script type="text/javascript"></script>

</body>
<script type="module">
    
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-analytics.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signInWithCustomToken, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-auth.js";
  import { getDatabase, ref, set, get, child, onValue, update, query, orderByChild, startAt } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-database.js";
  import { getStorage, ref as ref_storage, uploadBytes, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCvu5ybKhzq0WGnZnDjq7XHLrIHO1FcNrQ",
    authDomain: "revistaraara.firebaseapp.com",
    projectId: "revistaraara",
    storageBucket: "revistaraara.appspot.com",
    messagingSenderId: "563909133654",
    appId: "1:563909133654:web:1935150f4e1142725282f7",
    measurementId: "G-K1NTK125VS",
    databaseURL: "https://revistaraara-default-rtdb.europe-west1.firebasedatabase.app",
    storageBucket: 'gs://revistaraara.appspot.com'
  };
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const provider = new GoogleAuthProvider();
  const auth = getAuth();
  const db = getDatabase();
  const database = getDatabase();
  const storage = getStorage();

  //Está logeado?
  
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // User is signed in, see docs for a list of available properties
      // https://firebase.google.com/docs/reference/js/firebase.User
      const nextStep1 = document.getElementById("nextStep1")
      const uid = user.uid;

      const profileInput = document.getElementById("profileInput");
      const usernameInput = document.getElementById("usernameInput");
      const descInput = document.getElementById("descInput");
      const termsInput = document.getElementById("termsInput");

      //ROW 1

      profileInput.addEventListener("input", () => {

        var profileImg = profileInput.files[0]

        nextStep1.innerHTML = `<div class="spinner-grow spinner-grow-sm" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>`

        uploadBytes(ref_storage(storage, `profileImg/${user.uid}`), profileImg).then((snapshot) => {
                          
                const uploadTask = uploadBytesResumable(ref_storage(storage, `profileImg/${user.uid}`), profileImg);
                nextStep1.classList.add("disabled")
                uploadTask.on('state_changed',
                    (snapshot) => {
                        
                      const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        
                      document.getElementById("loader").innerHTML = `  
                      <div class="progress-bar bg-success bg-opacity-75" role="progressbar" style="width: ${progress}%;" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">Subiendo imagen</div>
                        `


                    },
                    (error) => {
                      // Handle unsuccessful uploads
                    },
                    () => {
                        
    
                      function editUserProfilePicture(uid, photoURL) {

                        var data = photoURL

                        const updates = {};
                        
                        updates['/users/' + uid + '/userInfo/userProfilePicture/'] = data;

                        return update(ref(db), updates);
                      }

                      getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {

                        setTimeout(() => {
    
                          profileButton.style.backgroundImage = `url(${downloadURL})`
                          nextStep1.innerHTML = `Seguir <i class="fas fa-arrow-right"></i>`
                          document.getElementById("loader").innerHTML = `  
                          <div class="progress-bar bg-primary bg-opacity-75" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">Imagen subida con éxito</div>
                          ` 
                          editUserProfilePicture(user.uid, downloadURL)
                            
                        }, 1500);



                      });



                      nextStep1.classList.remove("disabled")

                      nextStep1.addEventListener("click", () => {

                        document.getElementById("row1").classList.add("d-none")
                        document.getElementById("row2").classList.remove("d-none")

                      })
                      
                      
                    }
                  );
    
                });
    


      })

      //ROW 2

      function pad(n) {
            var s = "000" + n;
            var tag = s.substr(s.length-4)
            userNameTag.innerHTML = `#${tag}`
            return `#${tag}`;
        }
      let coincidences;
      let name; 
      usernameInput.addEventListener("input", (e) => {

        name = e.target.value;

        
        coincidences = 0;


        if(name){



          onValue(ref(db, 'users/'), (snapshot) => {

          var data = snapshot.val();
          data = Object.entries(data)

          data.forEach(e =>{ 

            const usernames = Object.entries(Object.entries(e[1])[2][1])[9][1]

            if(name == usernames){

              coincidences++

            }

          })

          })

          

          pad(coincidences)

          nextRow2.classList.remove("disabled")

        }else{

          nextRow2.classList.add("disabled")  

        }

      })
      function editUserName(uid, username, userTag) {

        var data = username
        var data2 = userTag

        const updates = {};

        updates['/users/' + uid + '/userInfo/username/'] = data;
        updates['/users/' + uid + '/userInfo/userTag/'] = data2;

        return update(ref(db), updates);

      }
      nextRow2.addEventListener("click", () => {

        editUserName(user.uid, name, pad(coincidences))

        document.getElementById("row2").classList.add("d-none");
        document.getElementById("row3").classList.remove("d-none");

      })

      //ROW 3

      let desc;
      function editUserDesc(uid, desc) {

        var data = desc

        const updates = {};

        updates['/users/' + uid + '/userInfo/userState/'] = data;

        return update(ref(db), updates);

      }
      descInput.addEventListener("input", (e) => {

        desc = e.target.value;
        console.log(desc)

        if(desc){

          document.getElementById("nextRow3").classList.remove("disabled")

          document.getElementById("nextRow3").addEventListener("click", () => {

            document.getElementById("row3").classList.add("d-none")
            document.getElementById("row4").classList.remove("d-none");

            editUserDesc(user.uid, desc)

          })
          
        }else{

          document.getElementById("nextRow3").classList.add("disabled")

        }

      }) 

      //ROW 4

      const nextRow4 = document.getElementById("nextRow4")
      termsInput.addEventListener("input", () => {

        if (termsInput.checked) {
          
          nextRow4.classList.remove("disabled")

        }else{

          nextRow4.classList.add("disabled")

        } 

      })
      nextRow4.addEventListener("click", () => {

        location.replace("./index.html")

      })
    
      //PREVIOUS ROWS 

      const previousRow2 = document.getElementById("previousRow2");
      const previousRow3 = document.getElementById("previousRow3");
      const previousRow4 = document.getElementById("previousRow4");
      const row1 = document.getElementById("row1");
      const row2 = document.getElementById("row2");
      const row3 = document.getElementById("row3");
      const row4 = document.getElementById("row4");

      previousRow2.addEventListener("click", () => {

        row1.classList.remove("d-none");
        row2.classList.add("d-none")

      })

      previousRow3.addEventListener("click", () => {

        row2.classList.remove("d-none");
        row3.classList.add("d-none")

      })

      previousRow4.addEventListener("click", () => {

        row3.classList.remove("d-none");
        row4.classList.add("d-none")

      })

    } else {
    
      location.replace("register.html")

    }
  });

</script>

</html>